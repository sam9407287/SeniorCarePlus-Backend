<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeniorCarePlus WebSocket 測試</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #d39e00;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #bd2130;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
        }
        .message.received {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .message.sent {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .message.system {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
        }
        .timestamp {
            color: #666;
            font-size: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-right: 2px;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            display: flex;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .input-group button {
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <h1>🏥 SeniorCarePlus WebSocket 測試工具</h1>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('location')">位置服務</button>
            <button class="tab" onclick="showTab('health')">健康數據</button>
            <button class="tab" onclick="showTab('alerts')">警報服務</button>
        </div>
        
        <!-- 位置服務標籤 -->
        <div id="location-tab" class="tab-content active">
            <div id="location-status" class="status disconnected">未連接到位置服務</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectLocation()">連接位置服務</button>
                <button class="btn-danger" onclick="disconnectLocation()">斷開連接</button>
                <button class="btn-success" onclick="sendLocationPing()">發送Ping</button>
                <button class="btn-warning" onclick="clearLocationMessages()">清除消息</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">位置更新數</div>
                    <div class="stat-value" id="location-updates">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">連接時間</div>
                    <div class="stat-value" id="location-uptime">00:00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">消息總數</div>
                    <div class="stat-value" id="location-messages">0</div>
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="device-query" placeholder="輸入設備ID查詢位置 (例: E001)">
                <button class="btn-primary" onclick="queryDeviceLocation()">查詢設備</button>
            </div>
            
            <div id="location-messages" class="messages"></div>
        </div>
        
        <!-- 健康數據標籤 -->
        <div id="health-tab" class="tab-content">
            <div id="health-status" class="status disconnected">未連接到健康服務</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectHealth()">連接健康服務</button>
                <button class="btn-danger" onclick="disconnectHealth()">斷開連接</button>
                <button class="btn-success" onclick="sendHealthPing()">發送Ping</button>
                <button class="btn-warning" onclick="clearHealthMessages()">清除消息</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="patient-query" placeholder="輸入患者ID訂閱 (例: P001)">
                <button class="btn-primary" onclick="subscribePatient()">訂閱患者</button>
            </div>
            
            <div id="health-messages" class="messages"></div>
        </div>
        
        <!-- 警報服務標籤 -->
        <div id="alerts-tab" class="tab-content">
            <div id="alerts-status" class="status disconnected">未連接到警報服務</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectAlerts()">連接警報服務</button>
                <button class="btn-danger" onclick="disconnectAlerts()">斷開連接</button>
                <button class="btn-warning" onclick="clearAlertsMessages()">清除消息</button>
            </div>
            
            <div id="alerts-messages" class="messages"></div>
        </div>
    </div>

    <script>
        // WebSocket 連接
        let locationWs = null;
        let healthWs = null;
        let alertsWs = null;
        
        // 統計數據
        let locationUpdates = 0;
        let locationConnectTime = null;
        let locationMessageCount = 0;
        
        // 工具函數
        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { hour12: false });
        }
        
        function addMessage(containerId, type, content) {
            const container = document.getElementById(containerId);
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `
                <div class="timestamp">[${formatTime(new Date())}]</div>
                <div>${content}</div>
            `;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
            
            // 更新消息計數
            if (containerId === 'location-messages') {
                locationMessageCount++;
                document.getElementById('location-messages').textContent = locationMessageCount;
            }
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }
        
        function updateConnectionTime() {
            if (locationConnectTime) {
                const now = new Date();
                const diff = Math.floor((now - locationConnectTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('location-uptime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // 位置服務功能
        function connectLocation() {
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                addMessage('location-messages', 'system', '已經連接到位置服務');
                return;
            }
            
            updateStatus('location-status', 'connecting', '正在連接到位置服務...');
            addMessage('location-messages', 'system', '正在連接到位置服務...');
            
            locationWs = new WebSocket('ws://localhost:8080/ws/location');
            
            locationWs.onopen = function(event) {
                updateStatus('location-status', 'connected', '已連接到位置服務');
                addMessage('location-messages', 'system', '✅ 位置服務連接成功');
                locationConnectTime = new Date();
                setInterval(updateConnectionTime, 1000);
            };
            
            locationWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    let content = `<strong>${message.type}</strong><br>`;
                    
                    if (message.type === 'location_update') {
                        locationUpdates++;
                        document.getElementById('location-updates').textContent = locationUpdates;
                        const data = message.data;
                        content += `設備: ${data.deviceId}<br>`;
                        content += `位置: (${data.x}, ${data.y})<br>`;
                        content += `電量: ${data.batteryLevel}%`;
                    } else {
                        content += `<pre style="margin:5px 0;">${JSON.stringify(message.data || message, null, 2)}</pre>`;
                    }
                    
                    addMessage('location-messages', 'received', content);
                } catch (e) {
                    addMessage('location-messages', 'received', `原始數據: ${event.data}`);
                }
            };
            
            locationWs.onerror = function(error) {
                updateStatus('location-status', 'disconnected', '位置服務連接錯誤');
                addMessage('location-messages', 'system', '❌ 連接錯誤: ' + error);
            };
            
            locationWs.onclose = function(event) {
                updateStatus('location-status', 'disconnected', '位置服務連接已關閉');
                addMessage('location-messages', 'system', `🔌 連接已關閉 (代碼: ${event.code})`);
                locationConnectTime = null;
            };
        }
        
        function disconnectLocation() {
            if (locationWs) {
                locationWs.close();
                locationWs = null;
                addMessage('location-messages', 'system', '手動斷開位置服務連接');
            }
        }
        
        function sendLocationPing() {
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                const ping = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                locationWs.send(JSON.stringify(ping));
                addMessage('location-messages', 'sent', '發送Ping: ' + JSON.stringify(ping, null, 2));
            } else {
                addMessage('location-messages', 'system', '❌ 未連接，無法發送Ping');
            }
        }
        
        function queryDeviceLocation() {
            const deviceId = document.getElementById('device-query').value.trim();
            if (!deviceId) {
                alert('請輸入設備ID');
                return;
            }
            
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                const query = {
                    type: 'get_device_location',
                    deviceId: deviceId
                };
                locationWs.send(JSON.stringify(query));
                addMessage('location-messages', 'sent', `查詢設備 ${deviceId}: ` + JSON.stringify(query, null, 2));
            } else {
                addMessage('location-messages', 'system', '❌ 未連接，無法查詢設備');
            }
        }
        
        function clearLocationMessages() {
            document.getElementById('location-messages').innerHTML = '';
            locationMessageCount = 0;
            document.getElementById('location-messages').textContent = '0';
        }
        
        // 健康服務功能
        function connectHealth() {
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                addMessage('health-messages', 'system', '已經連接到健康服務');
                return;
            }
            
            updateStatus('health-status', 'connecting', '正在連接到健康服務...');
            addMessage('health-messages', 'system', '正在連接到健康服務...');
            
            healthWs = new WebSocket('ws://localhost:8080/ws/health');
            
            healthWs.onopen = function(event) {
                updateStatus('health-status', 'connected', '已連接到健康服務');
                addMessage('health-messages', 'system', '✅ 健康服務連接成功');
            };
            
            healthWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    const content = `<strong>${message.type}</strong><br><pre style="margin:5px 0;">${JSON.stringify(message.data || message, null, 2)}</pre>`;
                    addMessage('health-messages', 'received', content);
                } catch (e) {
                    addMessage('health-messages', 'received', `原始數據: ${event.data}`);
                }
            };
            
            healthWs.onerror = function(error) {
                updateStatus('health-status', 'disconnected', '健康服務連接錯誤');
                addMessage('health-messages', 'system', '❌ 連接錯誤: ' + error);
            };
            
            healthWs.onclose = function(event) {
                updateStatus('health-status', 'disconnected', '健康服務連接已關閉');
                addMessage('health-messages', 'system', `🔌 連接已關閉 (代碼: ${event.code})`);
            };
        }
        
        function disconnectHealth() {
            if (healthWs) {
                healthWs.close();
                healthWs = null;
                addMessage('health-messages', 'system', '手動斷開健康服務連接');
            }
        }
        
        function sendHealthPing() {
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                const ping = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                healthWs.send(JSON.stringify(ping));
                addMessage('health-messages', 'sent', '發送Ping: ' + JSON.stringify(ping, null, 2));
            } else {
                addMessage('health-messages', 'system', '❌ 未連接，無法發送Ping');
            }
        }
        
        function subscribePatient() {
            const patientId = document.getElementById('patient-query').value.trim();
            if (!patientId) {
                alert('請輸入患者ID');
                return;
            }
            
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                const subscribe = {
                    type: 'subscribe_patient',
                    patientId: patientId
                };
                healthWs.send(JSON.stringify(subscribe));
                addMessage('health-messages', 'sent', `訂閱患者 ${patientId}: ` + JSON.stringify(subscribe, null, 2));
            } else {
                addMessage('health-messages', 'system', '❌ 未連接，無法訂閱患者');
            }
        }
        
        function clearHealthMessages() {
            document.getElementById('health-messages').innerHTML = '';
        }
        
        // 警報服務功能
        function connectAlerts() {
            if (alertsWs && alertsWs.readyState === WebSocket.OPEN) {
                addMessage('alerts-messages', 'system', '已經連接到警報服務');
                return;
            }
            
            updateStatus('alerts-status', 'connecting', '正在連接到警報服務...');
            addMessage('alerts-messages', 'system', '正在連接到警報服務...');
            
            alertsWs = new WebSocket('ws://localhost:8080/ws/alerts');
            
            alertsWs.onopen = function(event) {
                updateStatus('alerts-status', 'connected', '已連接到警報服務');
                addMessage('alerts-messages', 'system', '✅ 警報服務連接成功');
            };
            
            alertsWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    const content = `<strong>${message.type}</strong><br><pre style="margin:5px 0;">${JSON.stringify(message.alerts || message, null, 2)}</pre>`;
                    addMessage('alerts-messages', 'received', content);
                } catch (e) {
                    addMessage('alerts-messages', 'received', `原始數據: ${event.data}`);
                }
            };
            
            alertsWs.onerror = function(error) {
                updateStatus('alerts-status', 'disconnected', '警報服務連接錯誤');
                addMessage('alerts-messages', 'system', '❌ 連接錯誤: ' + error);
            };
            
            alertsWs.onclose = function(event) {
                updateStatus('alerts-status', 'disconnected', '警報服務連接已關閉');
                addMessage('alerts-messages', 'system', `🔌 連接已關閉 (代碼: ${event.code})`);
            };
        }
        
        function disconnectAlerts() {
            if (alertsWs) {
                alertsWs.close();
                alertsWs = null;
                addMessage('alerts-messages', 'system', '手動斷開警報服務連接');
            }
        }
        
        function clearAlertsMessages() {
            document.getElementById('alerts-messages').innerHTML = '';
        }
        
        // 標籤切換功能
        function showTab(tabName) {
            // 隱藏所有標籤內容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 移除所有標籤的active類
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 顯示選中的標籤內容
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 添加選中標籤的active類
            event.target.classList.add('active');
        }
        
        // 頁面載入時自動連接位置服務
        window.onload = function() {
            addMessage('location-messages', 'system', '🚀 WebSocket測試工具已載入，點擊"連接位置服務"開始測試');
            addMessage('health-messages', 'system', '🚀 健康服務測試已就緒');
            addMessage('alerts-messages', 'system', '🚀 警報服務測試已就緒');
        };
        
        // 頁面關閉時清理連接
        window.onbeforeunload = function() {
            if (locationWs) locationWs.close();
            if (healthWs) healthWs.close();
            if (alertsWs) alertsWs.close();
        };
    </script>
</body>
</html> 