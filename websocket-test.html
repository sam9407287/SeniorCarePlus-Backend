<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeniorCarePlus WebSocket æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #d39e00;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #bd2130;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
        }
        .message.received {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .message.sent {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        .message.system {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
        }
        .timestamp {
            color: #666;
            font-size: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-right: 2px;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            display: flex;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .input-group button {
            border-radius: 0 4px 4px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ SeniorCarePlus WebSocket æ¸¬è©¦å·¥å…·</h1>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('location')">ä½ç½®æœå‹™</button>
            <button class="tab" onclick="showTab('health')">å¥åº·æ•¸æ“š</button>
            <button class="tab" onclick="showTab('alerts')">è­¦å ±æœå‹™</button>
        </div>
        
        <!-- ä½ç½®æœå‹™æ¨™ç±¤ -->
        <div id="location-tab" class="tab-content active">
            <div id="location-status" class="status disconnected">æœªé€£æ¥åˆ°ä½ç½®æœå‹™</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectLocation()">é€£æ¥ä½ç½®æœå‹™</button>
                <button class="btn-danger" onclick="disconnectLocation()">æ–·é–‹é€£æ¥</button>
                <button class="btn-success" onclick="sendLocationPing()">ç™¼é€Ping</button>
                <button class="btn-warning" onclick="clearLocationMessages()">æ¸…é™¤æ¶ˆæ¯</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">ä½ç½®æ›´æ–°æ•¸</div>
                    <div class="stat-value" id="location-updates">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">é€£æ¥æ™‚é–“</div>
                    <div class="stat-value" id="location-uptime">00:00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ¶ˆæ¯ç¸½æ•¸</div>
                    <div class="stat-value" id="location-messages">0</div>
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="device-query" placeholder="è¼¸å…¥è¨­å‚™IDæŸ¥è©¢ä½ç½® (ä¾‹: E001)">
                <button class="btn-primary" onclick="queryDeviceLocation()">æŸ¥è©¢è¨­å‚™</button>
            </div>
            
            <div id="location-messages" class="messages"></div>
        </div>
        
        <!-- å¥åº·æ•¸æ“šæ¨™ç±¤ -->
        <div id="health-tab" class="tab-content">
            <div id="health-status" class="status disconnected">æœªé€£æ¥åˆ°å¥åº·æœå‹™</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectHealth()">é€£æ¥å¥åº·æœå‹™</button>
                <button class="btn-danger" onclick="disconnectHealth()">æ–·é–‹é€£æ¥</button>
                <button class="btn-success" onclick="sendHealthPing()">ç™¼é€Ping</button>
                <button class="btn-warning" onclick="clearHealthMessages()">æ¸…é™¤æ¶ˆæ¯</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="patient-query" placeholder="è¼¸å…¥æ‚£è€…IDè¨‚é–± (ä¾‹: P001)">
                <button class="btn-primary" onclick="subscribePatient()">è¨‚é–±æ‚£è€…</button>
            </div>
            
            <div id="health-messages" class="messages"></div>
        </div>
        
        <!-- è­¦å ±æœå‹™æ¨™ç±¤ -->
        <div id="alerts-tab" class="tab-content">
            <div id="alerts-status" class="status disconnected">æœªé€£æ¥åˆ°è­¦å ±æœå‹™</div>
            
            <div class="controls">
                <button class="btn-primary" onclick="connectAlerts()">é€£æ¥è­¦å ±æœå‹™</button>
                <button class="btn-danger" onclick="disconnectAlerts()">æ–·é–‹é€£æ¥</button>
                <button class="btn-warning" onclick="clearAlertsMessages()">æ¸…é™¤æ¶ˆæ¯</button>
            </div>
            
            <div id="alerts-messages" class="messages"></div>
        </div>
    </div>

    <script>
        // WebSocket é€£æ¥
        let locationWs = null;
        let healthWs = null;
        let alertsWs = null;
        
        // çµ±è¨ˆæ•¸æ“š
        let locationUpdates = 0;
        let locationConnectTime = null;
        let locationMessageCount = 0;
        
        // å·¥å…·å‡½æ•¸
        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { hour12: false });
        }
        
        function addMessage(containerId, type, content) {
            const container = document.getElementById(containerId);
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `
                <div class="timestamp">[${formatTime(new Date())}]</div>
                <div>${content}</div>
            `;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
            
            // æ›´æ–°æ¶ˆæ¯è¨ˆæ•¸
            if (containerId === 'location-messages') {
                locationMessageCount++;
                document.getElementById('location-messages').textContent = locationMessageCount;
            }
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }
        
        function updateConnectionTime() {
            if (locationConnectTime) {
                const now = new Date();
                const diff = Math.floor((now - locationConnectTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                document.getElementById('location-uptime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // ä½ç½®æœå‹™åŠŸèƒ½
        function connectLocation() {
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                addMessage('location-messages', 'system', 'å·²ç¶“é€£æ¥åˆ°ä½ç½®æœå‹™');
                return;
            }
            
            updateStatus('location-status', 'connecting', 'æ­£åœ¨é€£æ¥åˆ°ä½ç½®æœå‹™...');
            addMessage('location-messages', 'system', 'æ­£åœ¨é€£æ¥åˆ°ä½ç½®æœå‹™...');
            
            locationWs = new WebSocket('ws://localhost:8080/ws/location');
            
            locationWs.onopen = function(event) {
                updateStatus('location-status', 'connected', 'å·²é€£æ¥åˆ°ä½ç½®æœå‹™');
                addMessage('location-messages', 'system', 'âœ… ä½ç½®æœå‹™é€£æ¥æˆåŠŸ');
                locationConnectTime = new Date();
                setInterval(updateConnectionTime, 1000);
            };
            
            locationWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    let content = `<strong>${message.type}</strong><br>`;
                    
                    if (message.type === 'location_update') {
                        locationUpdates++;
                        document.getElementById('location-updates').textContent = locationUpdates;
                        const data = message.data;
                        content += `è¨­å‚™: ${data.deviceId}<br>`;
                        content += `ä½ç½®: (${data.x}, ${data.y})<br>`;
                        content += `é›»é‡: ${data.batteryLevel}%`;
                    } else {
                        content += `<pre style="margin:5px 0;">${JSON.stringify(message.data || message, null, 2)}</pre>`;
                    }
                    
                    addMessage('location-messages', 'received', content);
                } catch (e) {
                    addMessage('location-messages', 'received', `åŸå§‹æ•¸æ“š: ${event.data}`);
                }
            };
            
            locationWs.onerror = function(error) {
                updateStatus('location-status', 'disconnected', 'ä½ç½®æœå‹™é€£æ¥éŒ¯èª¤');
                addMessage('location-messages', 'system', 'âŒ é€£æ¥éŒ¯èª¤: ' + error);
            };
            
            locationWs.onclose = function(event) {
                updateStatus('location-status', 'disconnected', 'ä½ç½®æœå‹™é€£æ¥å·²é—œé–‰');
                addMessage('location-messages', 'system', `ğŸ”Œ é€£æ¥å·²é—œé–‰ (ä»£ç¢¼: ${event.code})`);
                locationConnectTime = null;
            };
        }
        
        function disconnectLocation() {
            if (locationWs) {
                locationWs.close();
                locationWs = null;
                addMessage('location-messages', 'system', 'æ‰‹å‹•æ–·é–‹ä½ç½®æœå‹™é€£æ¥');
            }
        }
        
        function sendLocationPing() {
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                const ping = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                locationWs.send(JSON.stringify(ping));
                addMessage('location-messages', 'sent', 'ç™¼é€Ping: ' + JSON.stringify(ping, null, 2));
            } else {
                addMessage('location-messages', 'system', 'âŒ æœªé€£æ¥ï¼Œç„¡æ³•ç™¼é€Ping');
            }
        }
        
        function queryDeviceLocation() {
            const deviceId = document.getElementById('device-query').value.trim();
            if (!deviceId) {
                alert('è«‹è¼¸å…¥è¨­å‚™ID');
                return;
            }
            
            if (locationWs && locationWs.readyState === WebSocket.OPEN) {
                const query = {
                    type: 'get_device_location',
                    deviceId: deviceId
                };
                locationWs.send(JSON.stringify(query));
                addMessage('location-messages', 'sent', `æŸ¥è©¢è¨­å‚™ ${deviceId}: ` + JSON.stringify(query, null, 2));
            } else {
                addMessage('location-messages', 'system', 'âŒ æœªé€£æ¥ï¼Œç„¡æ³•æŸ¥è©¢è¨­å‚™');
            }
        }
        
        function clearLocationMessages() {
            document.getElementById('location-messages').innerHTML = '';
            locationMessageCount = 0;
            document.getElementById('location-messages').textContent = '0';
        }
        
        // å¥åº·æœå‹™åŠŸèƒ½
        function connectHealth() {
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                addMessage('health-messages', 'system', 'å·²ç¶“é€£æ¥åˆ°å¥åº·æœå‹™');
                return;
            }
            
            updateStatus('health-status', 'connecting', 'æ­£åœ¨é€£æ¥åˆ°å¥åº·æœå‹™...');
            addMessage('health-messages', 'system', 'æ­£åœ¨é€£æ¥åˆ°å¥åº·æœå‹™...');
            
            healthWs = new WebSocket('ws://localhost:8080/ws/health');
            
            healthWs.onopen = function(event) {
                updateStatus('health-status', 'connected', 'å·²é€£æ¥åˆ°å¥åº·æœå‹™');
                addMessage('health-messages', 'system', 'âœ… å¥åº·æœå‹™é€£æ¥æˆåŠŸ');
            };
            
            healthWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    const content = `<strong>${message.type}</strong><br><pre style="margin:5px 0;">${JSON.stringify(message.data || message, null, 2)}</pre>`;
                    addMessage('health-messages', 'received', content);
                } catch (e) {
                    addMessage('health-messages', 'received', `åŸå§‹æ•¸æ“š: ${event.data}`);
                }
            };
            
            healthWs.onerror = function(error) {
                updateStatus('health-status', 'disconnected', 'å¥åº·æœå‹™é€£æ¥éŒ¯èª¤');
                addMessage('health-messages', 'system', 'âŒ é€£æ¥éŒ¯èª¤: ' + error);
            };
            
            healthWs.onclose = function(event) {
                updateStatus('health-status', 'disconnected', 'å¥åº·æœå‹™é€£æ¥å·²é—œé–‰');
                addMessage('health-messages', 'system', `ğŸ”Œ é€£æ¥å·²é—œé–‰ (ä»£ç¢¼: ${event.code})`);
            };
        }
        
        function disconnectHealth() {
            if (healthWs) {
                healthWs.close();
                healthWs = null;
                addMessage('health-messages', 'system', 'æ‰‹å‹•æ–·é–‹å¥åº·æœå‹™é€£æ¥');
            }
        }
        
        function sendHealthPing() {
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                const ping = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                healthWs.send(JSON.stringify(ping));
                addMessage('health-messages', 'sent', 'ç™¼é€Ping: ' + JSON.stringify(ping, null, 2));
            } else {
                addMessage('health-messages', 'system', 'âŒ æœªé€£æ¥ï¼Œç„¡æ³•ç™¼é€Ping');
            }
        }
        
        function subscribePatient() {
            const patientId = document.getElementById('patient-query').value.trim();
            if (!patientId) {
                alert('è«‹è¼¸å…¥æ‚£è€…ID');
                return;
            }
            
            if (healthWs && healthWs.readyState === WebSocket.OPEN) {
                const subscribe = {
                    type: 'subscribe_patient',
                    patientId: patientId
                };
                healthWs.send(JSON.stringify(subscribe));
                addMessage('health-messages', 'sent', `è¨‚é–±æ‚£è€… ${patientId}: ` + JSON.stringify(subscribe, null, 2));
            } else {
                addMessage('health-messages', 'system', 'âŒ æœªé€£æ¥ï¼Œç„¡æ³•è¨‚é–±æ‚£è€…');
            }
        }
        
        function clearHealthMessages() {
            document.getElementById('health-messages').innerHTML = '';
        }
        
        // è­¦å ±æœå‹™åŠŸèƒ½
        function connectAlerts() {
            if (alertsWs && alertsWs.readyState === WebSocket.OPEN) {
                addMessage('alerts-messages', 'system', 'å·²ç¶“é€£æ¥åˆ°è­¦å ±æœå‹™');
                return;
            }
            
            updateStatus('alerts-status', 'connecting', 'æ­£åœ¨é€£æ¥åˆ°è­¦å ±æœå‹™...');
            addMessage('alerts-messages', 'system', 'æ­£åœ¨é€£æ¥åˆ°è­¦å ±æœå‹™...');
            
            alertsWs = new WebSocket('ws://localhost:8080/ws/alerts');
            
            alertsWs.onopen = function(event) {
                updateStatus('alerts-status', 'connected', 'å·²é€£æ¥åˆ°è­¦å ±æœå‹™');
                addMessage('alerts-messages', 'system', 'âœ… è­¦å ±æœå‹™é€£æ¥æˆåŠŸ');
            };
            
            alertsWs.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    const content = `<strong>${message.type}</strong><br><pre style="margin:5px 0;">${JSON.stringify(message.alerts || message, null, 2)}</pre>`;
                    addMessage('alerts-messages', 'received', content);
                } catch (e) {
                    addMessage('alerts-messages', 'received', `åŸå§‹æ•¸æ“š: ${event.data}`);
                }
            };
            
            alertsWs.onerror = function(error) {
                updateStatus('alerts-status', 'disconnected', 'è­¦å ±æœå‹™é€£æ¥éŒ¯èª¤');
                addMessage('alerts-messages', 'system', 'âŒ é€£æ¥éŒ¯èª¤: ' + error);
            };
            
            alertsWs.onclose = function(event) {
                updateStatus('alerts-status', 'disconnected', 'è­¦å ±æœå‹™é€£æ¥å·²é—œé–‰');
                addMessage('alerts-messages', 'system', `ğŸ”Œ é€£æ¥å·²é—œé–‰ (ä»£ç¢¼: ${event.code})`);
            };
        }
        
        function disconnectAlerts() {
            if (alertsWs) {
                alertsWs.close();
                alertsWs = null;
                addMessage('alerts-messages', 'system', 'æ‰‹å‹•æ–·é–‹è­¦å ±æœå‹™é€£æ¥');
            }
        }
        
        function clearAlertsMessages() {
            document.getElementById('alerts-messages').innerHTML = '';
        }
        
        // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„activeé¡
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ·»åŠ é¸ä¸­æ¨™ç±¤çš„activeé¡
            event.target.classList.add('active');
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£æ¥ä½ç½®æœå‹™
        window.onload = function() {
            addMessage('location-messages', 'system', 'ğŸš€ WebSocketæ¸¬è©¦å·¥å…·å·²è¼‰å…¥ï¼Œé»æ“Š"é€£æ¥ä½ç½®æœå‹™"é–‹å§‹æ¸¬è©¦');
            addMessage('health-messages', 'system', 'ğŸš€ å¥åº·æœå‹™æ¸¬è©¦å·²å°±ç·’');
            addMessage('alerts-messages', 'system', 'ğŸš€ è­¦å ±æœå‹™æ¸¬è©¦å·²å°±ç·’');
        };
        
        // é é¢é—œé–‰æ™‚æ¸…ç†é€£æ¥
        window.onbeforeunload = function() {
            if (locationWs) locationWs.close();
            if (healthWs) healthWs.close();
            if (alertsWs) alertsWs.close();
        };
    </script>
</body>
</html> 